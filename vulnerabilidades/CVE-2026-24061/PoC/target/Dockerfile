FROM debian:stable-slim

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential wget ca-certificates \
    libncurses-dev libreadline-dev libpam0g-dev \
    openbsd-inetd netbase \
    iproute2 procps \
    netcat-traditional socat \
    bash-completion \
  && rm -rf /var/lib/apt/lists/*

WORKDIR /tmp/src
# Última versión vulnerable (según el lab): GNU InetUtils 2.7
RUN wget -O inetutils-2.7.tar.gz https://ftp.gnu.org/gnu/inetutils/inetutils-2.7.tar.gz \
  && tar -xzf inetutils-2.7.tar.gz

WORKDIR /tmp/src/inetutils-2.7
RUN mkdir -p /usr/local/etc \
  && CFLAGS="-fcommon" ./configure --prefix=/usr/local \
  && make -j"$(nproc)" \
  && make install \
  && (command -v in.telnetd || command -v telnetd || true) > /usr/local/etc/telnetd.path \
  && if [ ! -s /usr/local/etc/telnetd.path ]; then find /usr/local -maxdepth 4 -type f \( -name 'telnetd' -o -name 'in.telnetd' \) 2>/dev/null | head -n 1 > /usr/local/etc/telnetd.path; fi \
  && chmod 644 /usr/local/etc/telnetd.path \
  && ( [ -x /usr/local/sbin/in.telnetd ] || [ -x /usr/local/libexec/telnetd ] ) \
  && ( [ -x /usr/local/sbin/in.telnetd ] || ln -s /usr/local/libexec/telnetd /usr/local/sbin/in.telnetd ) \
  && ( [ -x /usr/local/libexec/telnetd ] || ln -s /usr/local/sbin/in.telnetd /usr/local/libexec/telnetd )

COPY entrypoint.sh /entrypoint.sh
COPY healthcheck.sh /healthcheck.sh
COPY banner.txt /etc/telnet-banner.txt
COPY motd.txt /etc/motd
COPY 10-ps1.sh /etc/profile.d/10-ps1.sh

RUN chmod +x /entrypoint.sh /healthcheck.sh \
  && chmod 755 /etc/profile.d/10-ps1.sh

# Usuario normal del target
RUN id -u idiot >/dev/null 2>&1 || useradd -m -s /bin/bash idiot \
  && echo 'idiot:idiot' | chpasswd

EXPOSE 23
ENTRYPOINT ["/entrypoint.sh"]
