#!/bin/sh
set -eu

[ -x /usr/sbin/inetd ] || { echo "[colador] error: /usr/sbin/inetd no existe (paquete openbsd-inetd)"; exit 1; }

TELNETD="$(cat /usr/local/etc/telnetd.path 2>/dev/null | head -n 1 || true)"
if [ -z "$TELNETD" ] || [ ! -x "$TELNETD" ]; then
  TELNETD="$(command -v in.telnetd 2>/dev/null || command -v telnetd 2>/dev/null || true)"
fi
[ -n "$TELNETD" ] && [ -x "$TELNETD" ] || { echo "[colador] error: telnetd no encontrado"; exit 1; }

# openbsd-inetd: usa nombre de servicio y fuerza IPv4.
if ! grep -Eq '^telnet[[:space:]]+23/tcp' /etc/services 2>/dev/null; then
  echo "telnet 23/tcp" >> /etc/services
fi

printf "%s\n" \
  "# telnet (red interna)" \
  "telnet stream tcp4 nowait root $TELNETD in.telnetd" \
  > /etc/inetd.conf

echo "[colador] inetd + telnet en :23"

while :; do
  /usr/sbin/inetd -d /etc/inetd.conf || true
  echo "[colador] inetd sali√≥; reintentando..."
  sleep 1
done
